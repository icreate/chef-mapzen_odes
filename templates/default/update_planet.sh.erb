#!/usr/bin/env bash -e

lockfile=.planet_update.lock
planet_file=<%= node[:mapzen_odes][:planet][:file] %>

echo -e "Checking for lockfile... \c"
if [ -f ${lockfile} ]; then
  echo "found, exiting."
  exit 1
else
  echo "not found, continuing."
fi

echo "Creating lockfile."
touch ${lockfile}

echo "Running osmupdate"
osmupdate ${planet_file} updated-${planet_file}

echo "Running osmconvert"
osmconvert updated-${planet_file} -o=planet_osmconvert.o5m

echo "Moving updates into place"
mv -f updated-${planet_file} ${planet_file}
mv -f planet_osmconvert.o5m planet.o5m

echo "Removing lockfile"
rm ${lockfile}
